(function(r,y){if(!r.QMAddress){var e=1e4,i={_moAddrBook:{},_moMap:{},initAddress:function(t){var o=this;if(o._mbIgnoreNoEmail="function"!=typeof t,"loading"!==o._sStatus){o._sStatus="loading",t&&t(o._sStatus);var r=y.T("/cgi-bin/laddr_lastlist?sid=$sid$&action=show_all_fast&t=addr_data_fast&type=list_recent_contact").replace({sid:y.getSid()});y.QMAjax.send(r,{onload:function(r,e){try{var i=y.evalValue(e||"")||{}}catch(n){i={}}if(r&&"0"===i.error)try{o._initData(i),o._sStatus="succeed"}catch(a){o._sStatus="fail"}else o._sStatus="fail";return t&&t(o._sStatus)}})}else t&&t("loading")},_initData:function(r){var e=this,i=r;e._moShared=i.shared;for(var n=i.personalGroups,a=0;a<n.length;a++){var t=n[a];n[a]={nid:M("group"),bParty:!0,name:t[0],id:t[1],children:[]},e._moMap["per_group_"+n[a].id]=n[a],e._moMap[n[a].nid]=n[a]}e._moPersonalTree={nid:M("group"),bParty:!0,id:"none",children:n},e._moMap[e._moPersonalTree.nid]=e._moPersonalTree,e._moMap["per_group_"+e._moPersonalTree.id]=e._moPersonalTree,e._moPersonalGroups=n;var o=i.clientGroups;for(a=0;a<o.length;a++){t=o[a];o[a]={nid:M("clientGroup"),bParty:!0,name:t[0],id:t[1],children:[]},e._moMap["client_group_"+o[a].id]=o[a],e._moMap[o[a].nid]=o[a]}for(var d in e._moClientTree={nid:M("clientGroup"),bParty:!0,id:"none",children:o},e._moMap[e._moClientTree.nid]=e._moClientTree,e._moMap["client_group_"+e._moClientTree.id]=e._moClientTree,e._moClientGroups=o,i.addrlist){var s=i.addrlist[d]||[],l=[];for(a=0;a<s.length;a++){var p=s[a];if(""==p[0]&&(p[0]="\u65e0\u59d3\u540d"),""!=p[1]||e._mbIgnoreNoEmail)if("biz"==d){var u={name:p[0],email:p[1],pinyin:p[2],uin:p[3],kind:d,nid:M("addr")};l.push(u),(e._moMap[u.nid]=u).email&&(e._moMap[u.email]=u);for(var _=p[4].split(","),m=0;""!=p[4]&&m<_.length;m++){var f={name:p[0],email:_[m],pinyin:p[2],uin:p[3],kind:d,nid:M("addr")};l.push(f),(e._moMap[f.nid]=f).email&&(e._moMap[f.email]=f)}}else{u={name:p[0],email:p[1],pinyin:p[2],kind:d,nid:M("addr")};if("personal"!=d&&"client"!=d||(u.id=p[4]),"personal"==d){var c=p[3].split(",");u.subgroups=c;for(var h=0;h<c.length;h++)if(c[h]){var g=e._moMap["per_group_"+c[h]];g&&g.children.push(u),"g_"==c[h].substring(0,2)&&-1==c[h].indexOf("@")&&e._moPersonalTree.children.push(u)}else e._moPersonalTree.children.push(u)}else if("client"==d){c=p[3].split(",");u.subgroups=c;for(h=0;h<c.length;h++)if(c[h]){var v=e._moMap["client_group_"+c[h]];v&&v.children.push(u)}else e._moClientTree.children.push(u)}l.push(u),(e._moMap[u.nid]=u).email&&(e._moMap[u.email]=u)}}e._moAddrBook[d]=l}},getPartyTree:function(o){var d=this;if(d._moPartyTree)return o&&o(d._moPartyTree);var r=y.T("/cgi-bin/laddr_biz?sid=$sid$&action=show_party_list&t=addr_data_party").replace({sid:y.getSid()});y.QMAjax.send(r,{onload:function(r,e){var i=y.evalValue(e||"")||{};if(r&&"0"===i.error){for(var n=i.oPartyList,a=0;a<n.length;a++){var t=n[a];t.nid=M("party"),t.children=[],t.bParty=!0,d._moMap[t.id]=t,d._moMap[t.nid]=t}d._moPartyTree=d._makeTree(n),o(d._moPartyTree)}}})},_makeTree:function(r){for(var e,i=r,n=0;n<i.length;n++){if("0"!=(a=i[n]).pid){if(a.parent=this._moMap[a.pid],!a.parent)continue;a.parent.children=a.parent.children||[],a.parent.children.push(a)}else e=a}for(var a,t=[e];a=t.pop();){var o=a.children;if(o){o.sort(function(r,e){return parseInt(r.order)-parseInt(e.order)});for(n=0;n<o.length;n++)t.push(o[n])}}return e},getFullParty:function(r,o){var d=this,s=d._moMap[r];if(s.bUserLoaded)return o&&o(s);var e=y.T("/cgi-bin/laddr_biz?sid=$sid$&action=show_party&t=addr_data_party&limit=50000&partyid=$partyid$").replace({partyid:s.id,sid:y.getSid()});y.QMAjax.send(e,{onload:function(r,e){var i=y.evalValue(e||"")||{};if(r&&"0"===i.error){for(var n=i.oUserList,a=0;a<n.length;a++){var t=n[a];t.nid=M("biz"),t.kind="biz",d._moMap[t.nid]=t,s.children.push(t)}s.bUserLoaded=!0,o(s)}}})},getAddressFromRemote:function(r,n){var a=this._moMap[r];if(a.bBizUser)return n&&n(a.bBizUser);var e=y.T("/cgi-bin/laddr_biz?sid=$sid$&action=show_party&t=addr_data_party&limit=50000&partyid=$partyid$&recursive=on").replace({partyid:a.id,sid:y.getSid()});y.QMAjax.send(e,{onload:function(r,e){var i=y.evalValue(e||"")||{};r&&"0"===i.error&&(a.bBizUser=i.oUserList,n(i.oUserList))}})},getAddress:function(r){var e=this._moMap[r];if(e){e.isgroup=!1;for(var i=getTop().QMAddress.getGroup("emailgroup")||[],n=0;n<i.length;n++)if(i[n].email==r||i[n].nid==r){e.isgroup=!0;break}return e}return{}},getPersonalAddrById:function(r){for(var e=this._moAddrBook.personal||[],i=null,n=0;n<e.length;n++){var a=e[n];if(a.id==r){i=a;break}}return i},getClientAddrById:function(r){for(var e=this._moAddrBook.client||[],i=null,n=0;n<e.length;n++){var a=e[n];if(a.id==r){i=a;break}}return i},search:function(r,e,i){var n=[],a={},t=e||20,o=i||["hot","personal","client","biz","emailgroup"],d=r.toUpperCase(),s=[];if(""===d)return n;for(var l=0;l<o.length;l++)for(var p=this._moAddrBook[o[l]]||[],u=0;u<p.length;u++){var _=p[u];if(!a[_.email+_.name]){var m=!1,f=-1,c=-1,h=-1;if(m||(m=-1<(f=_.email.toUpperCase().indexOf(d))),m||(m=-1<(c=_.name.toUpperCase().indexOf(d))),m||(m=-1<(h=_.pinyin.toUpperCase().indexOf(d))),m&&(a[_.email+_.name]=!0,0==_.email.toUpperCase().indexOf(d+"@")?s.push(_):0==f||0==c||0==h?n.unshift(_):n.push(_)),(!y.goExpers||!y.goExpers.full_addr_search)&&n.length>=t)return n}}var g=[].concat(s,n);if(y.goExpers&&y.goExpers.full_addr_search){var v=[];for(u=0;u<t;++u)g[u]&&v.push(g[u]);return v}return g},getGroup:function(r){return this._moAddrBook[r]},getPersonalGroups:function(){return this._moPersonalGroups},getPersonalTree:function(){return this._moPersonalTree},getClientGroups:function(){return this._moClientGroups},getClientTree:function(){return this._moClientTree},isInit:function(){return"succeed"==this._sStatus},isShared:function(r){return this._moShared[r]},isExpired:function(){return this._bExpired},setExpired:function(r){this._bExpired=r},isBizRoot:function(r){if(!r)return!1;var e=this._moMap[r];return!(!e||0!=e.pid)}};r.QMAddress=i}function M(r){return(r||"")+ ++e}})(window,getTop());